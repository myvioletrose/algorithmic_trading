#https://cran.r-project.org/web/packages/correlationfunnel/vignettes/introducing_correlation_funnel.html

################################################################
# step 0: get data
funnel_df = dplyr::inner_join(
        backtest_rand_evalDf %>%
                mutate(days_between = as.integer(days_between)) %>%
                select(rand_eval_index, symbol, date = eval_start_date, 
                       rank_by_upside_opp, chg_in_5_days = chg_in_close, 
                       message_type, days_between, is_win_yn, final_percent_chg = percent_chg),
        output2 %>%
                select(symbol, date, 
                       dmi_p, 
                       dmi_n, 
                       adx, 
                       rsi, 
                       cci, 
                       macd_diff, 
                       macd_trend_dir, 
                       macd_flag, 
                       macd_ha_flag, 
                       is_intraday_green_yn_ha, 
                       ha_flag, 
                       evwma_flag, 
                       overnight_flag, 
                       sma5_flag, 
                       rsi_oversold_flag, 
                       rsi_overbought_flag, 
                       cci_oversold_flag, 
                       cci_overbought_flag, 
                       situation, 
                       csp_doji, 
                       csp_dragonfly_doji, 
                       csp_gravestone_doji, 
                       csp_hammer, 
                       csp_inverted_harmer, 
                       csp_bullish_engulfing, 
                       csp_bearish_engulfing, 
                       csp_bullish_harami, 
                       csp_bearish_harami, 
                       csp_piercing_line, 
                       csp_dark_cloud_cover, 
                       csp_kick_up, 
                       csp_kick_down, 
                       csp_three_white_soliders, 
                       csp_three_black_crows, 
                       csp_morning_star, 
                       csp_evening_star, 
                       csp_rising_three, 
                       csp_failling_three, 
                       csp_up_trend, 
                       csp_down_trend, 
                       csp_bullish_candle, 
                       csp_bearish_candle, 
                       csp_candle_stick_signal
                ),
        by = c("symbol", "date")) %>%
        arrange(symbol, date)

################################################################
# step 1: prep data as binary features
binarized_df <- funnel_df %>%
        select(-symbol, -date, -rand_eval_index, -final_percent_chg) %>%
        binarize(n_bins = 5, thresh_infreq = 0.01, name_infreq = "<Others>", one_hot = TRUE)

binarized_df %>% glimpse()
# Rows: 384
# Columns: 107
# $ rank_by_upside_opp__1                                   <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ rank_by_upside_opp__2                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ rank_by_upside_opp__3                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `chg_in_5_days__-Inf_-0.035662927811333`                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `chg_in_5_days__-0.035662927811333_-0.0121784391578525` <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `chg_in_5_days__-0.0121784391578525_0.0133714913982665` <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ chg_in_5_days__0.0133714913982665_0.0365193868349864    <dbl> 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ chg_in_5_days__0.0365193868349864_Inf                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1…
# $ message_type__message_s1                                <dbl> 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0…
# $ message_type__message_s2                                <dbl> 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1…
# $ message_type__message_s3                                <dbl> 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0…
# $ `days_between__-Inf_7`                                  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ days_between__7_13                                      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0…
# $ days_between__13_17                                     <dbl> 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0…
# $ days_between__17_27                                     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ days_between__27_Inf                                    <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ is_win_yn__0                                            <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0…
# $ is_win_yn__1                                            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1…
# $ `dmi_p__-Inf_27.7302792085884`                          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ dmi_p__27.7302792085884_30.3061057295876                <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ dmi_p__30.3061057295876_32.8615151496441                <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0…
# $ dmi_p__32.8615151496441_36.5027408031965                <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1…
# $ dmi_p__36.5027408031965_Inf                             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ `dmi_n__-Inf_13.7206851869631`                          <dbl> 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ dmi_n__13.7206851869631_16.6263607691025                <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0…
# $ dmi_n__16.6263607691025_18.0338230288019                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ dmi_n__18.0338230288019_20.6215615105636                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ dmi_n__20.6215615105636_Inf                             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ `adx__-Inf_15.1988291087181`                            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ adx__15.1988291087181_19.1782311249964                  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ adx__19.1782311249964_23.031727523619                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ adx__23.031727523619_28.5989000682659                   <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1…
# $ adx__28.5989000682659_Inf                               <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0…
# $ `rsi__-Inf_58.7237278082548`                            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ rsi__58.7237278082548_61.7612910683186                  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ rsi__61.7612910683186_65.12671961628                    <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0…
# $ rsi__65.12671961628_69.5784734845916                    <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ rsi__69.5784734845916_Inf                               <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ `cci__-Inf_103.717120806426`                            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ cci__103.717120806426_154.093401399127                  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ cci__154.093401399127_181.830866242682                  <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0…
# $ cci__181.830866242682_216.670572546714                  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ cci__216.670572546714_Inf                               <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `macd_diff__-Inf_0.0511844748742607`                    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ macd_diff__0.0511844748742607_0.174280683285036         <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ macd_diff__0.174280683285036_0.562051451409163          <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ macd_diff__0.562051451409163_1.10100843689524           <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0…
# $ macd_diff__1.10100843689524_Inf                         <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ macd_trend_dir__0                                       <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1…
# $ macd_trend_dir__1                                       <dbl> 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ macd_flag__0                                            <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1…
# $ macd_flag__1                                            <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ macd_ha_flag__0                                         <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1…
# $ macd_ha_flag__1                                         <dbl> 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ ha_flag__0                                              <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ ha_flag__1                                              <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ evwma_flag__0                                           <dbl> 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ evwma_flag__1                                           <dbl> 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1…
# $ `overnight_flag__-1`                                    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ overnight_flag__0                                       <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0…
# $ overnight_flag__1                                       <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1…
# $ sma5_flag__0                                            <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ sma5_flag__1                                            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ rsi_overbought_flag__0                                  <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1…
# $ rsi_overbought_flag__1                                  <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0…
# $ cci_oversold_flag__0                                    <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0…
# $ cci_oversold_flag__1                                    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ cci_overbought_flag__0                                  <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1…
# $ cci_overbought_flag__1                                  <dbl> 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0…
# $ `situation__EBear-EBear::SBear-SBear`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBear-EBear::SBull-SBull`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
# $ `situation__EBear-EBull::SBull-SBull`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBear::SBear-SBear`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBear::SBear-SBull`                   <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBear::SBull-SBear`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ `situation__EBull-EBear::SBull-SBull`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBull::SBear-SBear`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBull::SBear-SBull`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBull::SBull-SBear`                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `situation__EBull-EBull::SBull-SBull`                   <dbl> 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0…
# $ `situation__<Others>`                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_doji__0                                             <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_doji__1                                             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_hammer__0                                           <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_hammer__1                                           <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_bullish_engulfing__0                                <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_bullish_engulfing__1                                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_bearish_engulfing__0                                <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_bearish_engulfing__1                                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_bearish_harami__0                                   <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_bearish_harami__1                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_piercing_line__0                                    <dbl> 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1…
# $ csp_piercing_line__1                                    <dbl> 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0…
# $ csp_dark_cloud_cover__0                                 <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_dark_cloud_cover__1                                 <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_kick_up__0                                          <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1…
# $ csp_kick_up__1                                          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0…
# $ csp_three_white_soliders__0                             <dbl> 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_three_white_soliders__1                             <dbl> 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_up_trend__1                                         <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ `csp_up_trend__<Others>`                                <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_bullish_candle__0                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_bullish_candle__1                                   <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_bearish_candle__0                                   <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
# $ csp_bearish_candle__1                                   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ `csp_candle_stick_signal__-1`                           <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
# $ csp_candle_stick_signal__1                              <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…

################################################################
# step 2: correlate to the target
corr_df <- binarized_df %>%
        correlate(is_win_yn__1)

corr_df
# # A tibble: 107 × 3
# feature        bin                                    correlation
# <fct>          <chr>                                        <dbl>
# 1 is_win_yn      0                                           -1    
# 2 is_win_yn      1                                            1    
# 3 chg_in_5_days  0.0365193868349864_Inf                       0.385
# 4 chg_in_5_days  -Inf_-0.035662927811333                     -0.300
# 5 chg_in_5_days  -0.035662927811333_-0.0121784391578525      -0.210
# 6 overnight_flag -1                                           0.177
# 7 adx            15.1988291087181_19.1782311249964            0.166
# 8 situation      EBull-EBull::SBear-SBear                     0.158
# 9 macd_flag      0                                            0.155
# 10 macd_flag      1                                           -0.155
# # … with 97 more rows
# # ℹ Use `print(n = ...)` to see more rows

################################################################
# step 3: plot the correlation funnel
windows()
corr_df %>%
        plot_correlation_funnel(interactive = TRUE)

